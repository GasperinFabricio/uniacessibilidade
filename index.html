<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Uniacessibilidade</title>
    <!-- Include Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Include Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Include Leaflet MarkerCluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
    />
    <!-- Include Leaflet MarkerCluster JavaScript -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <!-- Set Leaflet image path (necessary if your leaflet.js folder is in a different location) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <style>
      #map {
        height: 400px;
      }
      .custom-cluster-icon {
        background: rgba(255, 255, 255, 0.6);
        border-radius: 50%;
        border: 1px solid #ccc;
        text-align: center;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="search">
        <input type="text" class="searchTerm" placeholder="Pra onde vamos?" />
        <button type="submit" class="searchButton">
          <i class="fa fa-search"></i>
        </button>
      </div>
    </div>

    <div id="map"></div>

    <script>
      var map = L.map("map").setView([-22.89709, -43.10672], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // Initialize MarkerClusterGroup for clustering markers
      var markers = L.markerClusterGroup({
        // Customizing cluster icon to show average rating
        iconCreateFunction: function (cluster) {
          var childMarkers = cluster.getAllChildMarkers();
          var totalRating = 0;
          var totalVotes = 0;
          for (var i = 0; i < childMarkers.length; i++) {
            var votes = childMarkers[i].options.votes;
            for (var j = 0; j < votes.length; j++) {
              totalRating += votes[j];
            }
            totalVotes += votes.length;
          }
          var averageRating = totalRating / totalVotes;
          var roundedAverage = averageRating.toFixed(1); // Round to one decimal place
          return L.divIcon({
            html:
              '<div style="line-height: 1.6;">' +
              roundedAverage +
              "<br>Rating</div>",
            className: "custom-cluster-icon",
            iconSize: [40, 40],
          });
        },
      });
      map.addLayer(markers);

      // Unique ID generator for markers
      var markerId = 0;

      // Function to add marker on map click with rating input
      function addMarkerAndCluster(e) {
        var rating = prompt("Enter rating (1-5):");
        rating = parseInt(rating);

        if (isNaN(rating) || rating < 1 || rating > 5) {
          alert("Please enter a valid rating between 1 and 5.");
          return;
        }

        markerId++; // Increment marker ID for uniqueness
        var newMarker = L.marker(e.latlng, { votes: [rating], id: markerId }); // Store ratings in an array
        newMarker.bindPopup(
          "<div id='popup' data-id='" +
            markerId +
            "'><b>Waypoint</b><br>Rating: " +
            rating +
            "/5<br><button onclick='addVote(this)'>Add Vote</button></div>"
        );
        markers.addLayer(newMarker);
      }

      // Event listener for map click
      map.on("click", addMarkerAndCluster);

      // Function to add vote when user clicks 'Add Vote' button in the popup
      function addVote(element) {
        var markerId = parseInt(element.parentElement.getAttribute("data-id"));
        var marker = getMarkerById(markerId);
        var rating = prompt("Enter additional rating (1-5):");
        rating = parseInt(rating);

        if (isNaN(rating) || rating < 1 || rating > 5) {
          alert("Please enter a valid rating between 1 and 5.");
          return;
        }

        marker.options.votes.push(rating);
        updatePopupContent(marker);
      }

      // Function to get marker by ID
      function getMarkerById(id) {
        var marker;
        markers.eachLayer(function (m) {
          if (m.options.id === id) {
            marker = m;
          }
        });
        return marker;
      }

      // Function to update popup content with current average rating
      function updatePopupContent(marker) {
        var votes = marker.options.votes;
        var totalRating = 0;
        for (var i = 0; i < votes.length; i++) {
          totalRating += votes[i];
        }
        var averageRating = totalRating / votes.length;
        marker
          .getPopup()
          .setContent(
            "<div id='popup' data-id='" +
              marker.options.id +
              "'><b>Waypoint</b><br>Rating: " +
              averageRating.toFixed(1) +
              "/5<br><button onclick='addVote(this)'>Add Vote</button></div>"
          );
        marker.openPopup(); // Reopen the popup to show the updated content
      }
    </script>
  </body>
</html>
